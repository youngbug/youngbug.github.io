---
layout: post
title: 比特币钱包介绍
author: Zhao Yang(cnrgc@163.com)
location: 北京
pulished: true
category: SmartCard
tags: [cryptography, smartcard, bitcoin]
excerpt_separator:  <!--more-->
---

比特币钱包涉及钱包程序和钱包文件。钱包程序创建公钥来支付比特币(satoshis)，并使用对应的私钥来花掉比特币。钱包文件保存私钥和其他与钱包程序相关的交易信息(可选)。

## 钱包程序 Wallet Programs

允许接受和支付比特币是钱包软件的唯一功能，但是一个特定的钱包程序不需要同时做这两件事，两个钱包程序可以一起工作，一个程序分发公钥来接收比特币，一个程序进行交易签名来支付这些比特币。

钱包程序也需要和**peer-to-peer**网络进行交互，以从区块链中获得信息并广播出新的交易。当然，分发公钥和交易签名程序并不需要和**peer-to-peer**网络本身进行交互。

因此钱包系统(**wallet system**)就有三个必须的，但是缺可以独立的部分：一个公钥分发程序，一个签名程序，一个联网程序。

<!--more-->

>**NOTE:** 这里说的是公钥分发的通常情形。在一些情况下，P2PKH和P2SH的散列值将被分发来代替公钥的分发，实际的公钥只有在他们控制的output被支付时才分发。    
>上面和下面说的输出outputs，通常就是指 未使用的交易输出 **unspent transaction outputs** 缩写是UTXO，就是比特币。

## 完整功能的钱包 Full-Service Wallets

最简单的钱包是一个执行三个功能的程序：
- 生成私钥，并派生对应的公钥，并在需要时分发这些公钥；
- 监控支付给这个公钥的outputs，在支付outputs时，创建交易和进行交易签名；
- 广播已经完成签名的交易。

![img](/assets/blog_image/2022/20220318001-en-wallets-full-service.svg)

现在几乎所有流行的BTC钱包都是**Full-Service Wallets**。

**Full-Service Wallets**的优点是容易使用，单独的一个程序可以完成用户支付和接收比特币的全部工作。

**Full-Service Wallets**的缺点是，他们把私钥保存在可以连接到Internet的设备上，因为联网所以这样的设备中的私钥被攻击会很容易。

## 签名钱包 Signing-Only Wallets

私钥可以保存在一个在更安全环境中的单独的钱包程序中来提高安全性，这些签名钱包和可以与**peer-to-peer**网络交互的联网钱包配合使用。

签名钱包通常由确定性密钥(**deterministic key**)创建，用来创建可以生成子公私钥的父公私钥。

![img](/assets/blog_image/2022/20220318002-en-wallets-signing-only.svg)

当第一次运行时，签名钱包创建一个父私钥，并将对应的公钥传输给联网钱包。

联网钱包使用父公钥派生出子公钥，帮助分发他们（可选的），监控支付给这些公钥的outputs，创建没有签名的支付交易，并把没有签名的支付交易传输给签名钱包。

通常用户有机会使用签名钱包查看未签名交易的详情(尤其是outputs的详情)。

在用户查看步骤(可选的)之后，签名钱包使用父私钥派生相应的子私钥并进行交易签名，将签名的交易传回给联网钱包。

联网钱包把签名的交易广播到**peer-to-peer**网络上。

### 离线钱包 Offline Wallets

几个**full-service wallets**也可以当作两个独立的钱包使用：一个程序实例当作签名钱包(通常称为“离线钱包”)，另一个程序实例当作联网钱包(通常称作在线钱包或者监控钱包)。

脱机钱包在不联网的设备上运行，可以减少供给量。如果这种情况，通常由用户来掌握所有数据的传输和使用可移动设备比如USB驱动器。用户的工作流是这样的：

- 1.(离线)关闭设备上所有网络连接，并安装钱包软件。以脱机模式启动软件，创建父私钥和父公钥，并赋值父公钥到可移动介质上。

- 2.(在线)在另一台设备上安装钱包软件。这台设备联网，从可移动介质上导入父公钥。下面的过程就像使用**full-service wallet**一样，分发公钥来接收支付。当准备消费比特币时，填写output详情并把钱包生成的未签名的交易保存到可移动介质上。

- 3.(离线)在脱机实例中打开未签名的交易，审查交易的详情，确保支付金额和地址正确。这个可以阻止恶意软件(malware)欺骗用户签署交易，从而支付给攻击者。审查后，签署交易并保存到可移动介质。

- 4.(在线)在在线实例中打开已签名的交易，以便广播到**peer-to-peer**网络。

离线钱包的主要优点在于同完整功能的钱包相比，大大的提告了安全性。只要脱机钱包没有被破坏(或者有缺陷)，用户在签名之前会检查所有支付的交易，即使在线钱包被破坏，用户的比特币也是安全的。

离线钱包的主要缺点是麻烦，为了最大的安全性，要求用户必须离线操作。任何时候要支付比特币，都必须启动离线设备，用户必须从在线设备物理拷贝数据到离线设备并再从离线设备拷贝数据回在线设备。

### 硬件钱包 Hardware Wallets

硬件钱包是专门用于签名的钱包设备，一般是智能卡等安全芯片开发的设备。他们可以安全与其他联网设备通信，用户也不需要手动传输数据了。硬件钱包的工作流程是这样的：

- (硬件)生成父私钥和公钥，将硬件钱包连接到一个联网设备上，这样联网设备就可以获得父公钥；
- (联网)像使用完整功能钱包一样，分发公钥来接收支付，当准备支付比特币时，填写交易详情，连接硬件钱包，然后点击消费，联网钱包会将交易详情发送给硬件钱包；
- (硬件)查看硬件钱包屏幕上的交易详情，一些硬件钱包可能会提示输入PIN，硬件钱包对交易进行签名，并将交易签名返回给联网钱包。

## 分发钱包 Distributing-Only Wallets

运行再很难保证安全的环境中(比如web服务器)的钱包程序，只能设计成分发公钥而不能有其他功能。这种简单的钱包有两种常见的设计方法：

![img](/assets/blog_image/2022/20220318003-en-wallets-distributing-only.svg)

- 把大量的公钥或者地址保存到数据库中，然后根据请求分发一条数据库内的条目比如一个公钥或者地址。为了避免重复使用密钥，web服务器应该追踪使用过的密钥，并且永远不要用尽数据库中的公钥。

- 使用父公钥创建子公钥。为了避免重复使用密钥，必须使用一种方法确保一个公钥不会被分发两次。

这两种方法都不会增加大量的开销。

## 钱包文件 Wallet Files

比特币钱包的核心是一组私钥。这些集合被数字化的保存在一个文件中，甚至可以保存在一张纸上。

## 私钥格式 Private Key Formats

私钥是用来使用对应公钥地址