---
layout: post
title: CCC 数字钥匙Release 3 学习笔记 车主配对 Part3
time: 2023年4月12日
author: Zhao Yang(cnrgc@163.com)
location: 北京
pulished: true
category: cryptography
tags: [cryptography]
excerpt_separator:  <!--more-->
---

## 6.1 概述

车主配对由钥匙设备上的Digital Key framework来控制，通过使用APDU管理数字钥匙的配置，整个方案由智能卡芯片提供保护。

智能卡COS提供可信的根，提供信任链的起点。

车辆能够通过NFC使用数字钥匙的AID选择Digital Key applet，并通过对应的AID选择Digital Key framework。 基于选择AID，NFC控制器可以重新配置来改变和智能卡或者Digital Key framework通信，反之亦然。

新车主设备配对流或者车主设备修改不意味着有隐式的取消配对，比如，一个新钥匙设备车主配对流只改变车主的钥匙。存在的已经配对的共享/好友钥匙和车辆的公钥不会受到影响。

Digital Key applet实例应当在车主配对执行之前为可用状态。

<!--more-->

## 6.2 密钥和数据

下面定义了车主配对时用到的密钥和数据元素：

- *device.PK/device.SK*: 钥匙设备在数字钥匙创建时产生的长期密钥对。一个钥匙一对。

- *vehicle.PK/vehicle.SK*：车辆产生的密钥对。相同车辆的所有的数字钥匙这个密钥对相同。这个密钥对的声明周期，由主机厂规定，不在CCC数字钥匙规范里规定。

- *配对口令*：输入到钥匙设备的SPAKE2+配对口令。由主机厂账户提供的UTF8编码的8位数字（0-9），用于车主认证。

- *Kenc*：派生出的对称密钥（通过SPAKE2+共享密钥生成），用于加密保密的指令和响应负载。

- *Kmac*：派生的对称密钥（通过SPAKE2+共享密钥生成），用于计算指令C-APDU的MAC。

- *Krmac*：派生的对称密钥（通过SPAKE2+共享密钥生成），用于计算响应R-APDU的MAC。

## 6.3 车主配对实现

这部分描述了车主配对流程中不同阶段，包括：

- **阶段0**：准备（见6.3.1）

- **阶段1**：在车辆和钥匙设备上初始化配对过程（见6.3.2）

- **阶段2**：NFC读卡器的的第一个会话（见6.3.3）

- **阶段3**：NFC读卡器的第二个会话（见6.3.4）

- **阶段4**：结束配对过程（见6.3.5）

车主配对流程包括两个会话：第一个会话（阶段2）与Digital Key framework执行；第二个会话（阶段3）与Digital Key applet执行，如图6-1.在车主配对阶段2，车辆配置了是去主机厂服务器在线检索防盗令牌（immobilizer token）还是从车辆内检索。如果配置为在线检索，车主防盗令牌不会再第二个会话中通过NFC读卡器传输，但在配对时或者结束后在钥匙追踪请求/响应（Key Tracking Request/Response）至/来自 车辆主机厂服务器和车主钥匙设备厂家服务器传输。图6-1描述了车主配对过程（防盗令牌在车内检索）

第一个会话包括两个NFC交易。第一个交易是协商协议版本，执行SPAKE2+，并传输所有的钥匙创建数据到钥匙设备。第二个交易，在钥匙设备创建数字钥匙之后执行，提供创建的证明和证书链给车辆。

![img](/assets/blog_image/2023/202304120001-figure-6-1.png)

### 6.3.1 阶段0：准备

#### 6.3.1.1 设备准备

